<launch>

    <param name="/use_sim_time" value="true" />

    <arg name="UAV_NAME" default="$(env UAV_NAME)" />
    <arg name="PROFILER" default="$(optenv PROFILER false)" />
    <arg name="RUN_TYPE" default="$(env RUN_TYPE)" />

    <arg name="rviz_config" default="$(find aloam_slam)/rviz/$(arg UAV_NAME)_features.rviz" />
    <arg name="bag_path" default="$(env HOME)/bag_files" />
    <!-- <arg name="bag" default="sim_byci_skala_aloam_filt.bag" /> -->
    <arg name="bag" default="stara_voda_altitude_drift_high_res_filt.bag" />
    <!-- <arg name="bag" default="dataset_sim_beta_course_filt.bag" /> -->


  <!--//{ FRAMES -->
  <arg name="fcu_frame" default="$(arg UAV_NAME)/fcu"/>
  <arg name="lidar_frame" default="$(arg UAV_NAME)/os1_lidar"/>
  <arg name="odom_frame" default="$(arg UAV_NAME)/aloam_odom_origin"/>
  <arg name="map_frame" default="$(arg UAV_NAME)/aloam_origin"/>
  <!--//}-->

  <!--//{ SENSOR PARAMETERS -->
  <arg name="points_raw_topic" default="os1_cloud_node/points" />
  <arg name="points_proc_topic" default="os1_cloud_node/points_processed" />
  <arg name="number_of_rings" default="16" />
  <arg name="vertical_fov" default="33.2" />
  <arg name="frequency" default="10.0" />
  <!--//}-->

  <!--//{ DATA PROCESSING PARAMETERS -->
  <arg name="lidar3d/min_range" default="0.6" />
  <arg name="lidar3d/max_range" default="20.0" />
  <arg name="lidar3d/downsample_row_step" default="4" />
  <arg name="lidar3d/downsample_col_step" default="1" />
  <arg name="lidar3d/publish_cloud_over_max_range" default="true" />
  <arg name="lidar3d/filter/intensity" default="true" />
  <arg name="lidar3d/filter/intensity/value" default="100" />
  <arg name="lidar3d/filter/intensity/range" default="10.0" />
  
  <arg name="depth/republish" default="false" />
  <!--//}-->

  <!--//{ ALOAM PARAMETERS -->
  <arg name="aloam/verbose" default="false" />
  <arg name="aloam/mapping/rate" default="$(arg frequency)" />
  <arg name="aloam/mapping/publish_rate" default="0.5" />
  <arg name="aloam/mapping/resolution/line" default="0.4" />
  <arg name="aloam/mapping/resolution/plane" default="0.8" />
  <!--//}-->
 
    <!--//{ OCTOMAP SERVER PARAMETERS -->
    <arg name="map_builder" default="true" />
    <arg name="map_builder/topics" default="" />
    <arg name="map_builder/resolution" default="0.20" />
    <arg name="map_builder/alpha/occupied" default="1.0" />
    <arg name="map_builder/alpha/free" default="1.0" />
    <arg name="map_builder/sensor_model/p_hit" default="0.90" />
    <arg name="map_builder/sensor_model/p_miss" default="0.40" />
    <arg name="map_builder/sensor_model/clamp_min" default="0.3" />
    <arg name="map_builder/sensor_model/clamp_max" default="0.9" />
    <!--//}-->

  <!--//{ LAUNCH PARAMETERS -->
    <arg name="standalone" default="$(optenv OUSTER_STANDALONE false)" />
    <arg name="debug" default="$(optenv DEBUG false)" />
    <arg     if="$(eval arg('standalone') or arg('debug'))" name="nodelet" value="standalone" />
    <arg unless="$(eval arg('standalone') or arg('debug'))" name="nodelet" value="load" />
    <arg     if="$(eval arg('standalone') or arg('debug'))" name="nodelet_manager" value="" />
    <arg unless="$(eval arg('standalone') or arg('debug'))" name="nodelet_manager" value="$(arg UAV_NAME)_ouster_nodelet_manager" />
    <arg unless="$(arg debug)" name="launch_prefix" value=""/>
    <arg     if="$(arg debug)" name="launch_prefix" value="debug_roslaunch"/>
  <!--//}-->
      
    <!-- Rviz -->
    <node pkg="rviz" type="rviz" name="aloam_rviz" args="-d $(arg rviz_config)" />

    <!-- Rosbag -->
    <node pkg="rosbag" type="play" name="player" output="screen" args="--clock $(arg bag_path)/$(arg bag)" launch-prefix="bash -c 'sleep 1; $0 $@'"/>

    <!-- //{ LAUNCH NODELETS -->

    <!--//{ NODELET MANAGER -->
      <group ns="$(arg UAV_NAME)">
        <node if="$(eval arg('standalone') == 0)" pkg="nodelet" type="nodelet" name="$(arg nodelet_manager)" args="manager" output="screen" launch-prefix="$(arg launch_prefix)">
          <param name="num_worker_threads" value="8" />
        </node>
      </group>
    <!--//}-->

    <!--//{ DATA PROCESSING NODELET -->
    <include file="$(find mrs_pcl_tools)/launch/uav_os1_filtration.launch">
      <arg name="nodelet" value="$(arg nodelet)" />
      <arg name="nodelet_manager" value="$(arg nodelet_manager)" />
      <arg name="launch_prefix" value="$(arg launch_prefix)" />

      <!-- Ouster -->
      <arg name="lidar3d_republish" value="true" />
      <arg name="lidar3d_topic_in" value="$(arg points_raw_topic)" />
      <arg name="lidar3d_publish_cloud_over_max_range" value="$(eval arg('lidar3d/publish_cloud_over_max_range'))" />
      <arg name="lidar3d_min_range" value="$(arg lidar3d/min_range)" />
      <arg name="lidar3d_max_range" value="$(arg lidar3d/max_range)" />
      <arg name="lidar3d_downsample_row_step" default="$(arg lidar3d/downsample_row_step)" />
      <arg name="lidar3d_downsample_col_step" default="$(arg lidar3d/downsample_col_step)" />
      <arg if="$(eval arg('RUN_TYPE') == 'simulation')" name="lidar3d_filter_intensity_en" value="false" />
      <arg unless="$(eval arg('RUN_TYPE') == 'simulation')" name="lidar3d_filter_intensity_en" value="$(arg lidar3d/filter/intensity)" />
      <arg name="lidar3d_filter_intensity_thrd" value="$(arg lidar3d/filter/intensity/value)" />
      <arg name="lidar3d_filter_intensity_range" value="$(arg lidar3d/filter/intensity/range)" />

      <!-- Depth camera -->
      <arg name="depth_republish" value="$(arg depth/republish)" />

    </include>
    <!--//}-->

    <!--//{ OCTOMAP SERVER NODELET-->
    <include if="$(arg map_builder)" file="$(find octomap_server)/launch/uav_os1_nodelet.launch">
      <arg name="nodelet" value="$(arg nodelet)" />
      <arg name="nodelet_manager" value="$(arg nodelet_manager)" />
      <arg name="launch_prefix" value="$(arg launch_prefix)" />

      <arg name="UAV_NAME" value="$(arg UAV_NAME)"/>
      <arg name="map_frame" value="$(arg map_frame)" />

      <arg name="custom_config" value="$(arg map_builder/topics)" />
      <arg name="resolution" value="$(arg map_builder/resolution)" />
      <arg name="alpha_occupied" value="$(arg map_builder/alpha/occupied)" />
      <arg name="alpha_free" value="$(arg map_builder/alpha/free)" />
      <arg name="sensor_model_hit" value="$(arg map_builder/sensor_model/p_hit)" />
      <arg name="sensor_model_miss" value="$(arg map_builder/sensor_model/p_miss)" />
      <arg name="sensor_model_min" value="$(arg map_builder/sensor_model/clamp_min)" />
      <arg name="sensor_model_max" value="$(arg map_builder/sensor_model/clamp_max)" />
    </include>
    <!--//}-->

    <!--//{ ALOAM SLAM NODELET -->
    <include file="$(find aloam_slam)/launch/uav_os1.launch">
      <arg name="UAV_NAME" value="$(arg UAV_NAME)"/>
      <arg name="enable_profiler" value="$(arg PROFILER)" />
    
      <arg name="fcu_frame" value="$(arg fcu_frame)"/>
      <arg name="lidar_frame" value="$(arg lidar_frame)"/>
      <arg name="odom_frame" value="$(arg odom_frame)"/>
      <arg name="map_frame" value="$(arg map_frame)"/>

      <arg name="points_topic" value="$(arg points_proc_topic)" />
      <arg name="number_of_rings" value="$(arg number_of_rings)" />
      <arg name="vertical_fov" value="$(arg vertical_fov)"/>
      <arg name="sensor_frequency" value="$(arg frequency)"/>

      <arg name="mapping_rate" value="$(arg aloam/mapping/rate)" />
      <arg name="map_publish_rate" value="$(arg aloam/mapping/publish_rate)" />
      <arg name="mapping_line_resolution" value="$(arg aloam/mapping/resolution/line)" />
      <arg name="mapping_plane_resolution" value="$(arg aloam/mapping/resolution/plane)" />

      <arg name="verbose" value="$(arg aloam/verbose)"/>
      <arg name="nodelet" value="$(arg nodelet)" />
      <arg name="nodelet_manager" value="$(arg nodelet_manager)" />
      <arg name="launch_prefix" value="$(arg launch_prefix)" />
      <arg name="launch_delay" default="2" />

    </include>
    <!--//}-->
   
    <!--//}-->

    <!-- Ground truth TF --> 
    <!-- <node pkg="tf2_ros" type="static_transform_publisher" name="world_to_fcu" args="0 0 -0.21 0 0 1 0 $(arg UAV_NAME)/aloam_origin world" /> -->

</launch>
